<script>
(function () {
  onReady(fixCgitMarkdownImages);
  onReady(linkifyCgitSubtitles);

  /**
   * Runs a callback when DOM is ready.
   * @param {Function} fn
   */
  function onReady(fn) {
    document.readyState === "loading"
      ? document.addEventListener("DOMContentLoaded", fn, { once: true })
      : fn();
  }

  /**
   * Rewrites relative image URLs in cgit README ("about") pages
   * to use /<repo>/plain/<path>.
   */
  function fixCgitMarkdownImages() {
    const parts = location.pathname.split("/").filter(Boolean);
    if (parts[1] !== "about") return;

    const base =
      location.origin + "/" + parts[0] + "/plain/";

    const container = document.querySelector(".markdown-body");
    if (!container) return;

    container.querySelectorAll("img[src]").forEach(img => {
      const src = img.getAttribute("src");
      if (
        !src ||
        src.startsWith("http://") ||
        src.startsWith("https://") ||
        src.startsWith("//") ||
        src.startsWith("data:") ||
        src.startsWith("#")
      ) {
        return;
      }

      img.src = base + src.replace(/^\.?\//, "");
    });
  }

  /**
   * Converts plain-text URLs in repository subtitles into clickable links.
   */
  function linkifyCgitSubtitles() {
    const urlRe = /\bhttps?:\/\/[^\s<]+/g;

    document.querySelectorAll("td.sub").forEach(sub => {
      if (sub.querySelector("a")) return;

      const text = sub.textContent;
      if (!text || !urlRe.test(text)) return;

      urlRe.lastIndex = 0;
      sub.innerHTML = text.replace(urlRe, url =>
        `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`
      );
    });
  }
})();
</script>
